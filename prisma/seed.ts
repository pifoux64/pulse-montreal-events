/**
 * Script de seed pour Pulse Montreal
 * G√©n√®re des donn√©es de test r√©alistes pour Montr√©al
 */

import { PrismaClient } from '@prisma/client';
import { 
  UserRole, 
  EventCategory, 
  EventLanguage, 
  EventStatus, 
  EventSource,
  PromotionKind 
} from '@prisma/client';

const prisma = new PrismaClient();

// Donn√©es de base pour Montr√©al
const MONTREAL_VENUES = [
  {
    name: 'Place des Arts',
    address: '175 Rue Sainte-Catherine O',
    city: 'Montr√©al',
    postalCode: 'H2X 1Z8',
    lat: 45.5088,
    lon: -73.5673,
    neighborhood: 'Quartier des spectacles',
    website: 'https://placedesarts.com',
  },
  {
    name: 'Club Soda',
    address: '1225 Boul Saint-Laurent',
    city: 'Montr√©al',
    postalCode: 'H2X 2S6',
    lat: 45.5108,
    lon: -73.5697,
    neighborhood: 'Quartier des spectacles',
    website: 'https://clubsoda.ca',
  },
  {
    name: 'Th√©√¢tre Corona',
    address: '2490 Rue Notre-Dame O',
    city: 'Montr√©al',
    postalCode: 'H3J 1N5',
    lat: 45.4767,
    lon: -73.5821,
    neighborhood: 'Saint-Henri',
  },
  {
    name: 'Parc Jean-Drapeau',
    address: '1 Circuit Gilles Villeneuve',
    city: 'Montr√©al',
    postalCode: 'H3C 1A9',
    lat: 45.5017,
    lon: -73.5341,
    neighborhood: '√éle Sainte-H√©l√®ne',
  },
  {
    name: 'Mus√©e des beaux-arts de Montr√©al',
    address: '1380 Rue Sherbrooke O',
    city: 'Montr√©al',
    postalCode: 'H3G 1J5',
    lat: 45.4986,
    lon: -73.5794,
    neighborhood: 'Centre-ville',
    website: 'https://mbam.qc.ca',
  },
  {
    name: 'M√©tropolis',
    address: '59 Rue Sainte-Catherine E',
    city: 'Montr√©al',
    postalCode: 'H2X 1K5',
    lat: 45.5115,
    lon: -73.5626,
    neighborhood: 'Quartier des spectacles',
  },
  {
    name: 'Stade olympique',
    address: '4545 Av Pierre-De Coubertin',
    city: 'Montr√©al',
    postalCode: 'H1V 0B2',
    lat: 45.5576,
    lon: -73.5515,
    neighborhood: 'Hochelaga-Maisonneuve',
  },
  {
    name: 'Th√©√¢tre du Nouveau Monde',
    address: '84 Rue Sainte-Catherine O',
    city: 'Montr√©al',
    postalCode: 'H2X 1Z5',
    lat: 45.5087,
    lon: -73.5652,
    neighborhood: 'Quartier des spectacles',
  },
];

const EVENT_TEMPLATES = [
  // Musique
  {
    title: 'Festival International de Jazz de Montr√©al',
    description: 'Le plus grand festival de jazz au monde revient avec une programmation exceptionnelle mettant en vedette les plus grands noms du jazz international et local.',
    category: EventCategory.MUSIC,
    subcategory: 'Jazz',
    tags: ['festival', 'jazz', 'international', 'ext√©rieur'],
    language: EventLanguage.BOTH,
    priceMin: 0,
    priceMax: 12500, // 125$ en cents
  },
  {
    title: 'Soir√©e Reggae avec Alpha Blondy',
    description: 'Une soir√©e exceptionnelle avec la l√©gende du reggae ivoirien Alpha Blondy. Venez vibrer aux rythmes de ses plus grands succ√®s.',
    category: EventCategory.MUSIC,
    subcategory: 'Reggae',
    tags: ['reggae', 'concert', 'Alpha Blondy', 'world music'],
    language: EventLanguage.FR,
    priceMin: 4500, // 45$
    priceMax: 8500, // 85$
  },
  {
    title: 'Nuit Techno au Stereo',
    description: 'Une nuit de techno underground avec les meilleurs DJs locaux et internationaux. Ambiance √©lectrisante garantie jusqu\'au petit matin.',
    category: EventCategory.NIGHTLIFE,
    subcategory: 'Techno',
    tags: ['techno', 'electronic', 'nightclub', '18+'],
    language: EventLanguage.EN,
    priceMin: 2000, // 20$
    priceMax: 3500, // 35$
  },
  
  // Th√©√¢tre
  {
    title: 'Les Mis√©rables - Com√©die Musicale',
    description: 'La c√©l√®bre com√©die musicale de Claude-Michel Sch√∂nberg revient sur sc√®ne avec une mise en sc√®ne grandiose et des costumes somptueux.',
    category: EventCategory.THEATRE,
    subcategory: 'Com√©die musicale',
    tags: ['musical', 'th√©√¢tre', 'classique', 'famille'],
    language: EventLanguage.FR,
    priceMin: 5500, // 55$
    priceMax: 15000, // 150$
  },
  {
    title: 'Stand-up Comedy avec Sugar Sammy',
    description: 'Le roi de l\'humour qu√©b√©cois pr√©sente son nouveau spectacle hilarant qui m√©lange fran√ßais et anglais avec un talent in√©gal√©.',
    category: EventCategory.THEATRE,
    subcategory: 'Humour',
    tags: ['humour', 'stand-up', 'Sugar Sammy', 'bilingue'],
    language: EventLanguage.BOTH,
    priceMin: 4000, // 40$
    priceMax: 7500, // 75$
  },

  // Art et Culture
  {
    title: 'Exposition Picasso - ≈íuvres M√©connues',
    description: 'D√©couvrez une collection exceptionnelle d\'≈ìuvres m√©connues de Pablo Picasso, pr√©sent√©e pour la premi√®re fois au Canada.',
    category: EventCategory.EXHIBITION,
    subcategory: 'Peinture',
    tags: ['art', 'Picasso', 'peinture', 'exposition', 'culture'],
    language: EventLanguage.BOTH,
    priceMin: 2500, // 25$
    priceMax: 3500, // 35$
  },
  {
    title: 'Vernissage - Artistes √âmergents du Qu√©bec',
    description: 'Rencontrez les nouveaux talents de la sc√®ne artistique qu√©b√©coise lors de ce vernissage exclusif avec cocktail et musique live.',
    category: EventCategory.EXHIBITION,
    subcategory: 'Art contemporain',
    tags: ['vernissage', 'art contemporain', 'qu√©b√©cois', '√©mergent', 'gratuit'],
    language: EventLanguage.FR,
    priceMin: 0,
    priceMax: 0,
  },

  // Famille
  {
    title: 'Cirque du Soleil - Spectacle Familial',
    description: 'Un spectacle magique du Cirque du Soleil sp√©cialement con√ßu pour toute la famille. Acrobaties, musique et √©merveillement garantis.',
    category: EventCategory.FAMILY,
    subcategory: 'Cirque',
    tags: ['cirque', 'famille', 'enfants', 'Cirque du Soleil', 'spectacle'],
    language: EventLanguage.BOTH,
    priceMin: 3500, // 35$
    priceMax: 12000, // 120$
  },
  {
    title: 'Atelier Cuisine Parent-Enfant',
    description: 'Apprenez √† cuisiner ensemble lors de cet atelier interactif. Recettes simples et d√©licieuses adapt√©es aux petites mains.',
    category: EventCategory.FAMILY,
    subcategory: 'Atelier',
    tags: ['cuisine', 'atelier', 'parent-enfant', 'apprentissage', 'famille'],
    language: EventLanguage.FR,
    priceMin: 2500, // 25$
    priceMax: 2500,
  },

  // Sport
  {
    title: 'Match Canadiens vs Bruins',
    description: 'Le classique de la rivalit√© hockey entre les Canadiens de Montr√©al et les Bruins de Boston. Atmosph√®re √©lectrisante au Centre Bell.',
    category: EventCategory.SPORT,
    subcategory: 'Hockey',
    tags: ['hockey', 'Canadiens', 'NHL', 'Centre Bell', 'sport'],
    language: EventLanguage.BOTH,
    priceMin: 7500, // 75$
    priceMax: 35000, // 350$
  },
  {
    title: 'Marathon de Montr√©al',
    description: 'Participez au Marathon International de Montr√©al qui traverse les plus beaux quartiers de la ville. Inscription ouverte √† tous.',
    category: EventCategory.SPORT,
    subcategory: 'Course',
    tags: ['marathon', 'course', 'sport', 'participation', 'plein-air'],
    language: EventLanguage.BOTH,
    priceMin: 8500, // 85$
    priceMax: 12500, // 125$
  },

  // √âducation
  {
    title: 'Conf√©rence IA et Futur du Travail',
    description: 'Conf√©rence sur l\'impact de l\'intelligence artificielle sur le march√© du travail avec des experts internationaux.',
    category: EventCategory.EDUCATION,
    subcategory: 'Technologie',
    tags: ['IA', 'intelligence artificielle', 'travail', 'technologie', 'conf√©rence'],
    language: EventLanguage.FR,
    priceMin: 5000, // 50$
    priceMax: 15000, // 150$
  },
  {
    title: 'Atelier Photographie de Rue',
    description: 'Apprenez les techniques de la photographie de rue avec un photographe professionnel. Sortie pratique dans le Vieux-Montr√©al incluse.',
    category: EventCategory.EDUCATION,
    subcategory: 'Photographie',
    tags: ['photographie', 'atelier', 'apprentissage', 'rue', 'pratique'],
    language: EventLanguage.FR,
    priceMin: 7500, // 75$
    priceMax: 7500,
  },
];

async function main() {
  console.log('üå± D√©but du seeding de Pulse Montreal...');

  // 1. Cr√©er les cat√©gories
  console.log('üìÅ Cr√©ation des cat√©gories...');
  const categories = await Promise.all([
    prisma.category.upsert({
      where: { slug: 'musique' },
      update: {},
      create: {
        name: 'Musique',
        nameEn: 'Music',
        slug: 'musique',
        icon: 'üéµ',
        color: '#E53935',
        description: 'Concerts, festivals et √©v√©nements musicaux',
        descriptionEn: 'Concerts, festivals and musical events',
        sortOrder: 1,
      },
    }),
    prisma.category.upsert({
      where: { slug: 'theatre' },
      update: {},
      create: {
        name: 'Th√©√¢tre',
        nameEn: 'Theatre',
        slug: 'theatre',
        icon: 'üé≠',
        color: '#374151',
        description: 'Pi√®ces de th√©√¢tre, com√©dies et spectacles',
        descriptionEn: 'Plays, comedies and shows',
        sortOrder: 2,
      },
    }),
    prisma.category.upsert({
      where: { slug: 'art-culture' },
      update: {},
      create: {
        name: 'Art & Culture',
        nameEn: 'Art & Culture',
        slug: 'art-culture',
        icon: 'üé®',
        color: '#9B59B6',
        description: 'Expositions, vernissages et √©v√©nements culturels',
        descriptionEn: 'Exhibitions, openings and cultural events',
        sortOrder: 3,
      },
    }),
    prisma.category.upsert({
      where: { slug: 'famille' },
      update: {},
      create: {
        name: 'Famille',
        nameEn: 'Family',
        slug: 'famille',
        icon: 'üë®‚Äçüë©‚Äçüëß‚Äçüë¶',
        color: '#F39C12',
        description: 'Activit√©s et √©v√©nements familiaux',
        descriptionEn: 'Family activities and events',
        sortOrder: 4,
      },
    }),
    prisma.category.upsert({
      where: { slug: 'sport' },
      update: {},
      create: {
        name: 'Sport',
        nameEn: 'Sports',
        slug: 'sport',
        icon: '‚öΩ',
        color: '#3498DB',
        description: '√âv√©nements sportifs et activit√©s physiques',
        descriptionEn: 'Sports events and physical activities',
        sortOrder: 5,
      },
    }),
    prisma.category.upsert({
      where: { slug: 'education' },
      update: {},
      create: {
        name: '√âducation',
        nameEn: 'Education',
        slug: 'education',
        icon: 'üìö',
        color: '#27AE60',
        description: 'Conf√©rences, ateliers et formations',
        descriptionEn: 'Conferences, workshops and training',
        sortOrder: 6,
      },
    }),
  ]);

  // 2. Cr√©er les quartiers de Montr√©al
  console.log('üèòÔ∏è Cr√©ation des quartiers...');
  const neighborhoods = await Promise.all([
    prisma.neighborhood.upsert({
      where: { slug: 'quartier-des-spectacles' },
      update: {},
      create: {
        name: 'Quartier des spectacles',
        nameEn: 'Entertainment District',
        slug: 'quartier-des-spectacles',
        centerLat: 45.5088,
        centerLon: -73.5673,
      },
    }),
    prisma.neighborhood.upsert({
      where: { slug: 'vieux-montreal' },
      update: {},
      create: {
        name: 'Vieux-Montr√©al',
        nameEn: 'Old Montreal',
        slug: 'vieux-montreal',
        centerLat: 45.5017,
        centerLon: -73.5540,
      },
    }),
    prisma.neighborhood.upsert({
      where: { slug: 'plateau-mont-royal' },
      update: {},
      create: {
        name: 'Plateau-Mont-Royal',
        nameEn: 'Plateau-Mont-Royal',
        slug: 'plateau-mont-royal',
        centerLat: 45.5276,
        centerLon: -73.5794,
      },
    }),
    prisma.neighborhood.upsert({
      where: { slug: 'mile-end' },
      update: {},
      create: {
        name: 'Mile End',
        nameEn: 'Mile End',
        slug: 'mile-end',
        centerLat: 45.5276,
        centerLon: -73.6103,
      },
    }),
  ]);

  // 3. Cr√©er des utilisateurs de test
  console.log('üë• Cr√©ation des utilisateurs...');
  const adminUser = await prisma.user.upsert({
    where: { email: 'admin@pulse-montreal.com' },
    update: {},
    create: {
      email: 'admin@pulse-montreal.com',
      name: 'Admin Pulse',
      role: UserRole.ADMIN,
    },
  });

  const organizerUser = await prisma.user.upsert({
    where: { email: 'organizer@pulse-montreal.com' },
    update: {},
    create: {
      email: 'organizer@pulse-montreal.com',
      name: 'Organisateur Test',
      role: UserRole.ORGANIZER,
    },
  });

  const regularUser = await prisma.user.upsert({
    where: { email: 'user@pulse-montreal.com' },
    update: {},
    create: {
      email: 'user@pulse-montreal.com',
      name: 'Utilisateur Test',
      role: UserRole.USER,
    },
  });

  // 4. Cr√©er un profil organisateur
  const organizer = await prisma.organizer.upsert({
    where: { userId: organizerUser.id },
    update: {},
    create: {
      userId: organizerUser.id,
      displayName: '√âv√©nements Pulse',
      website: 'https://pulse-montreal.com',
      verified: true,
      socials: {
        facebook: 'https://facebook.com/pulse-montreal',
        instagram: 'https://instagram.com/pulse_montreal',
        twitter: 'https://twitter.com/pulse_montreal',
      },
    },
  });

  // 5. Cr√©er les venues
  console.log('üè¢ Cr√©ation des lieux...');
  const venues = await Promise.all(
    MONTREAL_VENUES.map(venueData =>
      prisma.venue.upsert({
        where: { 
          id: venueData.name.toLowerCase().replace(/[^a-z0-9]/g, '-') 
        },
        update: {},
        create: {
          id: venueData.name.toLowerCase().replace(/[^a-z0-9]/g, '-'),
          ...venueData,
        },
      })
    )
  );

  // 6. Cr√©er les √©v√©nements
  console.log('üéâ Cr√©ation des √©v√©nements...');
  const events = [];
  
  for (let i = 0; i < EVENT_TEMPLATES.length * 3; i++) {
    const template = EVENT_TEMPLATES[i % EVENT_TEMPLATES.length];
    const venue = venues[Math.floor(Math.random() * venues.length)];
    
    // Dates al√©atoires dans les 3 prochains mois
    const startDate = new Date();
    startDate.setDate(startDate.getDate() + Math.floor(Math.random() * 90) + 1);
    startDate.setHours(Math.floor(Math.random() * 12) + 18); // Entre 18h et 6h
    startDate.setMinutes([0, 15, 30, 45][Math.floor(Math.random() * 4)]);
    
    const endDate = new Date(startDate);
    endDate.setHours(endDate.getHours() + Math.floor(Math.random() * 4) + 1);

    const event = await prisma.event.create({
      data: {
        title: `${template.title} ${i > EVENT_TEMPLATES.length ? `#${Math.floor(i / EVENT_TEMPLATES.length) + 1}` : ''}`,
        description: template.description,
        startAt: startDate,
        endAt: endDate,
        timezone: 'America/Montreal',
        status: EventStatus.SCHEDULED,
        source: EventSource.INTERNAL,
        sourceId: `seed-${i}`,
        venueId: venue.id,
        organizerId: organizer.id,
        url: `https://pulse-montreal.com/events/seed-${i}`,
        priceMin: template.priceMin,
        priceMax: template.priceMax,
        currency: 'CAD',
        language: template.language,
        tags: template.tags,
        category: template.category,
        subcategory: template.subcategory,
        accessibility: Math.random() > 0.7 ? ['wheelchair'] : [],
        imageUrl: `https://picsum.photos/800/600?random=${i}`,
      },
    });

    events.push(event);
  }

  // 7. Cr√©er quelques promotions
  console.log('üí´ Cr√©ation des promotions...');
  const featuredEvents = events.slice(0, 5);
  
  for (const event of featuredEvents) {
    await prisma.promotion.create({
      data: {
        eventId: event.id,
        kind: PromotionKind.FEATURED,
        startsAt: new Date(),
        endsAt: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000), // 7 jours
        priceCents: Math.floor(Math.random() * 10000) + 5000, // 50-150$
      },
    });
  }

  // 8. Cr√©er des pr√©f√©rences utilisateur
  console.log('‚öôÔ∏è Cr√©ation des pr√©f√©rences...');
  await prisma.userPreferences.createMany({
    data: [
      {
        userId: adminUser.id,
        favoriteCategories: ['musique', 'theatre'],
        language: 'fr',
      },
      {
        userId: organizerUser.id,
        favoriteCategories: ['art-culture', 'education'],
        language: 'fr',
      },
      {
        userId: regularUser.id,
        favoriteCategories: ['musique', 'sport', 'famille'],
        language: 'fr',
      },
    ],
    skipDuplicates: true,
  });

  // 9. Cr√©er quelques favoris
  console.log('‚ù§Ô∏è Cr√©ation des favoris...');
  const favoriteEvents = events.slice(0, 8);
  
  for (const event of favoriteEvents) {
    await prisma.favorite.createMany({
      data: [
        { userId: regularUser.id, eventId: event.id },
        ...(Math.random() > 0.5 ? [{ userId: organizerUser.id, eventId: event.id }] : []),
      ],
      skipDuplicates: true,
    });
  }

  console.log('‚úÖ Seeding termin√© avec succ√®s !');
  console.log(`üìä R√©sum√© :`);
  console.log(`  - ${categories.length} cat√©gories`);
  console.log(`  - ${neighborhoods.length} quartiers`);
  console.log(`  - 3 utilisateurs (admin, organisateur, utilisateur)`);
  console.log(`  - ${venues.length} lieux`);
  console.log(`  - ${events.length} √©v√©nements`);
  console.log(`  - ${featuredEvents.length} promotions`);
  console.log(`  - Favoris et pr√©f√©rences cr√©√©s`);
}

main()
  .catch((e) => {
    console.error('‚ùå Erreur lors du seeding:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
